<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<head>
    <title>Reservar Habitaciones</title>
    <link rel="stylesheet" th:href="@{busqueda-habitacion.css}">
</head>
<body th:attr="data-modo=${modoAccion}">

<div class="top-bar" layout:fragment="top-bar-content">
    Premier
</div>

<div class="form-container" layout:fragment="content">
    <aside class="leyenda-container">
        <h2>Leyenda</h2>
        <ul class="leyenda">
            <li><span class="status-circle status-seleccionada"></span>Seleccionada</li>
            <li><span class="status-circle status-fuera_de_servicio"></span>Fuera de servicio</li>
            <li><span class="status-circle status-reservada"></span>Reservadas</li>
            <li><span class="status-circle status-ocupada"></span>Ocupada</li>
            <li><span class="status-circle status-libre"></span>Libre</li>
        </ul>
        <h3>Capacidad Habitaciones:</h3>
        <ul>
        	<li>Individual Estandard: 1</li>
        	<li>Doble Estandard: 2</li>
        	<li>Doble Superior: 2</li>
        	<li>Superior Family Plan: 5</li>
        	<li>Suite Doble: 2</li>
        </ul>
    </aside>

    <div class="main-content">

        <!-- SECCIÓN 1: BUSQUEDA + GRILLA -->
        <div id="seccion-busqueda-grilla">
            <h1 th:text="${modoAccion == 'RESERVAR'} ? 'Reservar Habitaciones'
                      : (${modoAccion == 'OCUPAR'} ? 'Ocupar Habitación' : 'Disponibilidad de Habitaciones')">
                Reservar Habitaciones
            </h1>

            <div class="busqueda-container">
                <form id="form-busqueda"
                      th:action="@{/habitaciones/buscar}"
                      th:object="${busquedaDTO}"
                      method="get">
                    <input type="hidden" name="accion" th:value="${modoAccion}" />

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha-desde">Fecha desde</label>
                            <input type="date" id="fecha-desde" th:field="*{fechaInicio}">
                        </div>
                        <div class="form-group">
                            <label for="fecha-hasta">Fecha hasta</label>
                            <input type="date" id="fecha-hasta" th:field="*{fechaFin}">
                        </div>
                        <button type="submit" class="btn-primary">BUSCAR</button>
                    </div>
                </form>
            </div>

            <form id="form-seleccion"
                  th:action="@{/reservas/confirmar}"
                  method="post"
                  th:if="${calendario.mapaDisponibilidad != null and not #maps.isEmpty(calendario.mapaDisponibilidad)}">

                <div class="grilla-container">
                    <table class="grilla-habitaciones">
                        <thead>
                        <tr>
                            <th rowspan="2">Fecha</th>
                            <th th:each="entry : ${calendario.habitacionesAgrupadas}"
                                th:colspan="${#lists.size(entry.value)}"
                                th:text="${entry.key}">
                                Doble Superior
                            </th>
                        </tr>

                        <tr>
                            <th:block th:each="entry : ${calendario.habitacionesAgrupadas}">
                                <th th:each="hab : ${entry.value}"
                                    th:text="${hab.numeroHabitacion}">
                                    101
                                </th>
                            </th:block>
                        </tr>
                        </thead>

                        <tbody>
<tr th:each="fecha : ${calendario.fechas}">

    <th th:text="${#temporals.format(fecha, 'dd/MM/yyyy')}"
        th:data-fecha="${fecha}">
        04/11/2025
    </th>

    <th:block th:each="entry : ${calendario.habitacionesAgrupadas}">
        <td th:each="hab : ${entry.value}"
            class="celda-interactiva"
            th:data-habitacion="${hab.numeroHabitacion}"
            th:data-fecha="${fecha}"
            
            th:with="estadoDTO=${calendario.mapaDisponibilidad.get(fecha).get(hab.numeroHabitacion)}"
         
            th:attr="data-estado=${estadoDTO.estado.toString()}, 
                     data-tipo=${entry.key},
                     data-id-estado=${estadoDTO.idEstado},
                     data-nombres-responsable=${estadoDTO.nombresResponsable},
                     data-apellidos-responsable=${estadoDTO.apellidosResponsable}">

            <div class="cell-content"
                 th:attr="data-estado=${estadoDTO.estado.toString()}">

                <th:block th:if="${estadoDTO.estado == T(edu.inbugwethrust.premier.suite.model.EstadoHabitacion).LIBRE}">
                    <input type="checkbox"
                           class="hidden-checkbox"
                           th:id="'chk_' + ${hab.numeroHabitacion} + '_' + ${fecha}"
                           name="celdasSeleccionadas"
                           th:value="${hab.numeroHabitacion} + '_' + ${fecha}" />

                    <div class="status-circle status-libre"></div>
                </th:block>

                <th:block th:unless="${estadoDTO.estado == T(edu.inbugwethrust.premier.suite.model.EstadoHabitacion).LIBRE}">
    
    <div class="cell-content-wrapper"> <div class="status-circle"
             th:classappend="' status-' + ${estadoDTO.estado.toString().toLowerCase()}"
             th:text="${estadoDTO.idEstado}"> </div>

        <div class="custom-tooltip" 
             th:if="${estadoDTO.nombresResponsable != null or estadoDTO.apellidosResponsable != null}">
            <span th:text="${estadoDTO.apellidosResponsable}">Pérez</span>, 
            <span th:text="${estadoDTO.nombresResponsable}">Juan</span>
        </div>

    </div>

</th:block>

            </div>
        </td>
    </th:block>
</tr>
</tbody>
                    </table>
                </div>
            </form>

            <!-- Botones inferiores: se ocultan en modo DISPONIBILIDAD -->
            <div class="botones-inferiores" th:if="${modoAccion != 'DISPONIBILIDAD'}">
                <button type="button" class="btn-secondary" id="open-modal-btn">CANCELAR</button>
                <button type="button" class="btn-secondary" id="reset-btn">LIMPIAR</button>
                <button type="button" class="btn-primary" id="btn-siguiente" form="form-seleccion">
						    SIGUIENTE
						</button>
            </div>
        </div>

        <!-- SECCIÓN 2: RESUMEN (solo RESERVAR) -->
        <div id="seccion-resumen" class="hidden" th:if="${modoAccion == 'RESERVAR'}">
            <h1>Reservar Habitaciones</h1>

            <div class="resumen-wrapper">
                <table class="tabla-resumen">
                    <thead>
                    <tr>
                        <th>Tipo de Habitaciones</th>
                        <th>Ingreso</th>
                        <th>Egreso</th>
                    </tr>
                    </thead>
                    <tbody id="tbody-resumen">
                    <!-- filas cargadas desde JS -->
                    </tbody>
                </table>
            </div>

            <div class="botones-resumen">
                <button type="button" class="btn-secondary" id="btn-resumen-cancelar">CANCELAR</button>
                <button type="button" class="btn-primary" id="btn-resumen-aceptar">ACEPTAR</button>
            </div>
        </div>

        <!-- SECCIÓN 3: DATOS HUÉSPED (solo RESERVAR) -->
        <div id="seccion-datos-huesped" class="hidden" th:if="${modoAccion == 'RESERVAR'}">
            <h1>Reservar Habitaciones</h1>

            <div class="datos-huesped-form">
                <h2>Reservar a nombre de:</h2>

                <div id="mensaje-error-huesped" class="mensaje-error hidden">
                    Debe completar todos los campos obligatorios.
                </div>

                <form id="form-reserva-final" th:action="@{/reservas/confirmar}" method="post">

                    <div class="fila-campos">
                        <div class="form-group">
                            <label for="apellido">Apellido *</label>
                            <input type="text" id="apellido" name="apellido" placeholder="APELLIDO">
                        </div>

                        <div class="form-group">
                            <label for="nombre">Nombre *</label>
                            <input type="text" id="nombre" name="nombre" placeholder="NOMBRE">
                        </div>

                        <div class="form-group">
                            <label for="telefono">Teléfono *</label>
                            <input type="text" id="telefono" name="telefono" placeholder="0000000000">
                        </div>
                    </div>

                    <!-- Inputs hidden con SeleccionHabitacionDTO se agregan por JS -->

                    <div class="botonera-final">
                        <button type="button" class="btn-secondary" id="btn-final-cancelar">CANCELAR</button>
                        <button type="submit" class="btn-primary">ACEPTAR</button>
                    </div>

                </form>
            </div>
        </div>

    </div>
</div>
<div layout:fragment="modals">
    <div id="modal-conflicto-reserva" class="modal-overlay">
        <div class="modal-box" style="border-top: 5px solid #f1c40f;">
            <div class="modal-header">
                <div class="warning-header" style="display:flex; gap:10px; align-items:center; color:#f39c12;">
                    <span style="font-size:1.5em;">⚠</span> 
                    <span>HABITACIÓN RESERVADA</span>
                </div>
                <span>Premier</span>
            </div>
            
            <div class="modal-content" style="text-align: left; font-size: 1rem;">
                <p>Las siguientes habitaciones tienen reservas en las fechas seleccionadas:</p>
                <ul id="lista-conflictos" style="background: #f9f9f9; padding: 15px; border-left: 3px solid #f1c40f; list-style: none;">
                    </ul>
                <p style="margin-top: 20px; font-weight: bold; text-align: center;">
                    ¿Desea ocupar la habitación de todas formas?
                </p>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn-modal" id="btn-conflicto-volver">VOLVER</button>
                <button type="button" class="btn-modal" id="btn-conflicto-ocupar-igual" style="background-color: #f39c12; border:none;">OCUPAR IGUAL</button>
            </div>
        </div>
    </div>
    <div id="modal-espera" class="modal-overlay">
    <div class="modal-box-espera">
        <div class="modal-header-premier">
            <span>Premier</span>
        </div>
        <div class="modal-content-espera">
            <p>PRESIONE CUALQUIER TECLA PARA CONTINUAR...</p>
        </div>
    </div>
</div>
</div>

<th:block layout:fragment="scripts">
    <script th:src="seleccion-rango.js"></script>
</th:block>
</html>
